package com.example.myrestapi.controller;

import com.example.myrestapi.dto.MyReqDTO;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.media.Content;
import io.swagger.v3.oas.annotations.media.Schema;
import io.swagger.v3.oas.annotations.responses.ApiResponse;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import javax.validation.Valid;

@RestController
@RequestMapping("/myendpoint")
public class MyRestController {

    @PostMapping
    @Operation(summary = "Process MyReq Data", responses = {
            @ApiResponse(responseCode = "200", description = "Successful operation"),
            @ApiResponse(responseCode = "400", description = "Bad Request (Validation Error)", content = @Content(schema = @Schema(hidden = true)))
    })
    public ResponseEntity<?> processMyReq(@RequestBody @Valid MyReqDTO myReqDTO) {
        // ... your processing logic ...

        return ResponseEntity.ok("MyReq data processed successfully!");
    }
}


package com.example.myrestapi.dto;

import lombok.Data;
import javax.validation.Valid;
import javax.validation.constraints.*;

@Data
public class MyReqDTO {

    @Pattern(regexp = "^\\d{8}$", message = "Date must be in YYYYMMDD format")
    private String date;

    private String opDesc;

    @Size(max = 32)
    private String refNum;

    @Pattern(regexp = "^\\d{1,2}\\.\\d{1,2}\\.\\d{1,2}$", message = "Invalid version format")
    private String mver;

    @Pattern(regexp = "^(0[1-9]|99)$", message = "Invalid opCat value")
    private String opCat;

    @Size(max = 255)
    private String severity;

    @Pattern(regexp = "^https://.+", message = "URL must start with 'https://'")
    @NotBlank
    private String url;

    @Valid
    @NotNull
    private TransRef transRef;
}

@Data
class TransRef {
    @Pattern(regexp = "^(0[1-3])$", message = "Invalid type value")
    private String type;

    @Size(max = 32)
    private String id;
}


<dependencies>
    <dependency>
        <groupId>org.springdoc</groupId>
        <artifactId>springdoc-openapi-ui</artifactId>
        <version>1.7.0</version>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-validation</artifactId>
    </dependency>
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <optional>true</optional>
    </dependency>
</dependencies>


package com.example.myrestapi.controller;

import com.example.myrestapi.dto.MyReqDTO;
import com.example.myrestapi.dto.TransRef;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;
import org.springframework.http.MediaType;
import org.springframework.test.web.servlet.MockMvc;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.jsonPath;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

@WebMvcTest(MyRestController.class)
class MyRestControllerTests {

    @Autowired
    private MockMvc mockMvc;

    @Autowired
    private ObjectMapper objectMapper;

    @Test
    void testProcessMyReq_success() throws Exception {
        MyReqDTO validRequest = createValidRequest();
        mockMvc.perform(post("/myendpoint")
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsString(validRequest)))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$").value("MyReq data processed successfully!"));
    }

    // Negative Test Cases

    @Test
    void testProcessMyReq_invalidDate() throws Exception {
        MyReqDTO invalidDateRequest = createValidRequest();
        invalidDateRequest.setDate("202311");
        testBadRequest(invalidDateRequest, "Date must be in YYYYMMDD format");
    }

    @Test
    void testProcessMyReq_invalidMver() throws Exception {
        MyReqDTO invalidMverRequest = createValidRequest();
        invalidMverRequest.setMver("1.2");
        testBadRequest(invalidMverRequest, "Invalid version format");
    }

    @Test
    void testProcessMyReq_invalidUrl() throws Exception {
        MyReqDTO invalidUrlRequest = createValidRequest();
        invalidUrlRequest.setUrl("http://example.com"); // Missing https://
        testBadRequest(invalidUrlRequest, "URL must start with 'https://'");
    }

    @Test
    void testProcessMyReq_invalidOpCat() throws Exception {
        MyReqDTO invalidOpCatRequest = createValidRequest();
        invalidOpCatRequest.setOpCat("10");  // Outside allowed range
        testBadRequest(invalidOpCatRequest, "Invalid opCat value");
    }

    @Test
    void testProcessMyReq_missingRequiredFields() throws Exception {
        MyReqDTO missingFieldsRequest = new MyReqDTO(); // Empty object
        testBadRequest(missingFieldsRequest, "date: must not be null"); // First missing field's error
    }

    @Test
    void testProcessMyReq_invalidTransRefType() throws Exception {
        MyReqDTO invalidTransRefRequest = createValidRequest();
        invalidTransRefRequest.getTransRef().setType("04"); // Invalid type
        testBadRequest(invalidTransRefRequest, "transRef.type: Invalid type value");
    }

    @Test
    void testProcessMyReq_missingTransRef() throws Exception {
        MyReqDTO missingTransRefRequest = createValidRequest();
        missingTransRefRequest.setTransRef(null);
        testBadRequest(missingTransRefRequest, "transRef: must not be null");
    }

    @Test
    void testProcessMyReq_invalidRefNumLength() throws Exception {
        MyReqDTO invalidRefNumRequest = createValidRequest();
        invalidRefNumRequest.setRefNum("ThisRefNumIsTooLongForTheValidationRule");
        testBadRequest(invalidRefNumRequest, "refNum: size must be between 0 and 32");
    }
    
    @Test
    void testProcessMyReq_invalidSeverityLength() throws Exception {
        MyReqDTO invalidSeverityRequest = createValidRequest();
        invalidSeverityRequest.setSeverity("ThisSeverityIsWayTooLongForThe255CharacterLimit");
        testBadRequest(invalidSeverityRequest, "severity: size must be between 0 and 255");
    }
    
    @Test
    void testProcessMyReq_invalidTransRefIdLength() throws Exception {
        MyReqDTO invalidTransRefIdRequest = createValidRequest();
        invalidTransRefIdRequest.getTransRef().setId("ThisTransRefIdIsTooLongForTheValidationRule");
        testBadRequest(invalidTransRefIdRequest, "transRef.id: size must be between 0 and 32");
    }

    private MyReqDTO createValidRequest() {
        MyReqDTO request = new MyReqDTO();
        request.setDate("20231231");
        request.setOpDesc("Sample Description");
        request.setRefNum("REF12345"); 
        request.setMver("1.2.3");
        request.setOpCat("01");
        request.setSeverity("High");
        request.setUrl("https://www.example.com");
        TransRef transRef = new TransRef();
        transRef.setType("01");
        transRef.setId("1234567890");
        request.setTransRef(transRef);
        return request;
    }

    private void testBadRequest(MyReqDTO request, String expectedErrorMessage) throws Exception {
        mockMvc.perform(post("/myendpoint")
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsString(request)))
                .andExpect(status().isBadRequest())
                .andExpect(jsonPath("$.errors[0].message").value(expectedErrorMessage)); 
    }
}

